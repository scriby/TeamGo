<!DOCTYPE html>
<html lang="en">
<head>
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="/css/teamgo.css" rel="stylesheet">
    <link href="/css/board.css" rel="stylesheet">
    <link href="/css/chat.css" rel="stylesheet">
</head>

<body>
<div class="navbar">
    <div class="navbar-inner">
        <div class="container">
            <a class="brand" href="#">TeamGo</a>
            <div class="nav-collapse">
                <div class="nav pull-right navbar-form">
                    <a class="btn btn-primary">
                        <i class="icon-retweet" style="vertical-align: middle"></i>
                        Link KGS Account
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row-fluid" style="margin-top:10px">
        <div class="span8">
            <div class="game" data-bind="visible: doneLoading" style="display:none">
                <h3 data-bind="visible: !gameInProgress()">
                    TeamGo is not currently playing a game.
                </h3>
                <!-- spacing between tags is important in the next block to prevent spaces between squares -->
                <div class="board" data-bind="visible: gameInProgress, foreach: rows"><div data-bind="foreach: $data"><div
                    class="intersection"
                    data-bind="
                        click: click,
                        attr: {
                            'data-x': $data.x,
                            'data-y': $data.y
                        }">
                        <div class="intersection-inner">
                            <div class="hoshi">
                                <div class="stone $data.status()"
                                     data-bind="
                                        css: {
                                            white: status() === 'white',
                                            black: status() === 'black',
                                            'vote-1': votes() === 1,
                                            'vote-2': votes() === 2,
                                            'vote-3': votes() === 3,
                                            'vote-4': votes() === 4,
                                            'vote-5': votes() >= 5
                                        },
                                        text: votes() > 0 ? votes() : ''
                                        "
                                >
                                </div>
                            </div>
                        </div>
                    </div></div>
                </div>
            </div>
        </div>
        <div class="span3">
            <div class="chat well">
                <div class="chat-messages" data-bind="foreach: messages">
                    <div class="chat-message">
                        <span class="chat-message-from" data-bind="text: from"></span>:
                        <span class="chat-message-text" data-bind="text: text"></span>
                    </div>
                </div>
                <div class="chat-entry form-inline">
                    <input type="text" data-bind="value: chatMessage, executeOnEnter: sendClick, valueUpdate: 'afterkeydown'" />

                    <a class="btn btn-primary" data-bind="click: sendClick">
                        <i class="icon-comment" style="vertical-align: middle"></i>
                        Send
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="game-status row-fluid">
        <div>
            Black captures: <span data-bind="text: players.black.captures()"></span>
        </div>
        <div>
            White captures: <span data-bind="text: players.white.captures()"></span>
        </div>
        <div>
            <span data-bind="visible: remainingSeconds() > 0">
                Move timer: <span data-bind="text: remainingSeconds"></span> seconds
            </span>
        </div>
    </div>
</div>

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script type="text/javascript" src="/js/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="/js/knockout.js"></script>
    <script type="text/javascript" src="/js/EventEmitter.js"></script>
    <script type="text/javascript" src="/nowjs/now.js"></script>
    <script type="text/javascript" src="/js/controller/board.js"></script>
    <script type="text/javascript" src="/js/controller/chat.js"></script>


    <script type="text/javascript">
        (function(){
            var initialized = false;

            ko.bindingHandlers.executeOnEnter = {
                init: function (element, valueAccessor, allBindingsAccessor, viewModel) {
                    var allBindings = allBindingsAccessor();
                    $(element).keypress(function (event) {
                        var keyCode = (event.which ? event.which : event.keyCode);
                        if (keyCode === 13) {
                            allBindings.executeOnEnter.call(viewModel);
                            return false;
                        }
                        return true;
                    });
                }
            };

            var getSessionId = function(){
                var possible = 'abcdefghijklmnopqrstuvwxyz0123456789';
                var sessionId = '';

                for(var i = 0; i < 16; i++){
                    sessionId += possible[Math.floor(Math.random() * possible.length)];
                }

                return sessionId;
            };

            now.ready(function(){
                now.playMove = function(color, x, y){
                    console.log(color + ',' + x + ',' + y);

                    tg.board.stopCountdownTimer();
                    tg.board.isMyTurn = false;
                    tg.board.events.removeAllListeners('intersectionClick');

                    tg.board.playMove(color, x, y);
                };

                now.genMove = function(color, secondsLeft, callback){
                    //Ignore additional genMove calls that might come when new players join
                    if(tg.board.isMyTurn){
                        return;
                    }

                    tg.board.remainingSeconds(secondsLeft);
                    tg.board.startCountdownTimer();

                    console.log('genmove '  + color);

                    tg.board.isMyTurn = true;

                    //If the player got disconnected during his turn, the old event handler will still be around
                    tg.board.events.removeAllListeners('intersectionClick');
                    tg.board.events.on('intersectionClick', function(intersection){
                        if(tg.board.checkMove(color, intersection.x, intersection.y)) {
                            callback(null, intersection.x, intersection.y);
                        }
                    });
                };

                now.setColor = function(color){
                    tg.board.myColor = color;
                };

                now.clearBoard = function(){
                    tg.board.clear();
                };

                now.setUsername = function(username){
                    console.log(username);
                };

                now.addVote = function(color, x, y){
                    tg.board.addVote(color, x, y);
                };

                now.removeVote = function(color, x, y){
                    tg.board.removeVote(color, x, y);
                };

                setInterval(function(){
                    tg.board.gameInProgress(now.inGame);
                }, 1000);

                var cookie = $.cookie('teamgo');
                if(cookie == null){
                    //Security isn't important for this site
                    var sessionId = getSessionId();
                    $.cookie('teamgo', JSON.stringify({ s: sessionId }));
                    cookie = $.cookie('teamgo');
                }

                cookie = JSON.parse(cookie);
                now.login(cookie.s, function(){
                    now.joinPlayers();
                });

                if(!initialized){
                    ko.applyBindings(tg.board, $('.game')[0]);
                    ko.applyBindings(tg.board, $('.game-status')[0]);

                    $('.board').on('hover', '.stone', function(event){
                        var target = $(event.target);
                        if(event.type === 'mouseleave') {
                            target.removeClass('preview-' + tg.board.myColor);
                        }

                        if(!tg.board.myColor || !tg.board.isMyTurn) {
                            return;
                        }

                        var intersection = target.closest('[data-x]');

                        var x = parseInt(intersection.attr('data-x'));
                        var y = parseInt(intersection.attr('data-y'));

                        if(event.type === 'mouseenter') {
                            if(tg.board.checkMove(tg.board.myColor, x, y)){
                                target.addClass('preview-' + tg.board.myColor);
                            }
                        }
                    });

                    var chatRoot = $('.chat')[0];
                    ko.applyBindings(tg.chat, chatRoot);

                    initialized = true;
                }
            });
        })();
    </script>

</body>
</html>
